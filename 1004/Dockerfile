# Docker image for TYPO3 CMS
# Copyright (C) 2025  Stefan B端rk <stefan@buerk.tech>
#                     and contributors <https://github.com/sbuerk/typo3-experimental-composermode-container/graphs/contributors>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

# NOTE: This file is automatically generated from a template. Please
# do not make any changes to this file directly, and consult the
# CONTRIBUTING document, first.

FROM ghcr.io/sbuerk/typo3-base-apache2-phpfpm72:1.0
ARG TARGETPLATFORM
LABEL org.opencontainers.image.authors="Stefan B端rk <stefan@buerk.tech>"
LABEL org.opencontainers.image.source=https://github.org/sbuerk/typo3-experimental-composermode-container/1004
LABEL org.opencontainers.image.url=https://github.org/sbuerk/typo3-experimental-composermode-container/README.md
LABEL org.opencontainers.image.description="sbuerk/typo3-experimental-composermode-container-1004"
LABEL maintainer="Stefan B端rk <stefan@buerk.tech>"

ENV PROJECT_DOCROOT="/var/www/html/project/public"

RUN cd /var/www/html/project \
    && composer init \
      --name='typo3/demo-instance-104' \
      --author='Stefan B端rk <stefan@buerk.tech>' \
      --type='project' \
      --stability='stable' \
      --license='GPL-2.0-or-later' \
      --no-interaction \
    && composer config "allow-plugins" true \
    && composer require -W \
        "typo3/cms-about:^10.4" \
        "typo3/cms-adminpanel:^10.4" \
        "typo3/cms-backend:^10.4" \
        "typo3/cms-belog:^10.4" \
        "typo3/cms-beuser:^10.4" \
        "typo3/cms-core:^10.4" \
        "typo3/cms-dashboard:^10.4" \
        "typo3/cms-extbase:^10.4" \
        "typo3/cms-extensionmanager:^10.4" \
        "typo3/cms-filelist:^10.4" \
        "typo3/cms-fluid:^10.4" \
        "typo3/cms-fluid-styled-content:^10.4" \
        "typo3/cms-form:^10.4" \
        "typo3/cms-frontend:^10.4" \
        "typo3/cms-impexp:^10.4" \
        "typo3/cms-info:^10.4" \
        "typo3/cms-install:^10.4" \
        "typo3/cms-lowlevel:^10.4" \
        "typo3/cms-opendocs:^10.4" \
        "typo3/cms-recordlist:^10.4" \
        "typo3/cms-recycler:^10.4" \
        "typo3/cms-redirects:^10.4" \
        "typo3/cms-reports:^10.4" \
        "typo3/cms-rte-ckeditor:^10.4" \
        "typo3/cms-scheduler:^10.4" \
        "typo3/cms-seo:^10.4" \
        "typo3/cms-setup:^10.4" \
        "typo3/cms-tstemplate:^10.4" \
        "typo3/cms-viewpage:^10.4" \
        "typo3/cms-introduction":"^4.3.2" \
        "helhum/typo3-console":"^6.7.7" \
    && cp public/typo3/sysext/install/Resources/Private/FolderStructureTemplateFiles/root-htaccess public/.htaccess \
    && mkdir -p public/typo3temp \
    && mkdir -p public/typo3conf \
    && mkdir -p public/fileadmin \
    && mkdir -p public/uploads \
    && mkdir -p config \
    && mkdir -p var \
    && cd /var/www/html \
    && chmod -R a+rw project \
    && chmod -R o+r project

WORKDIR /var/www/html/project

ENV PATH="$PROJECT_DOCROOT/bin:/var/www/html/project/bin:$PROJECT_DOCROOT/vendor/bin:/var/www/html/project/vendor/bin:$PATH"

# Configure volumes
VOLUME /var/www/html/project/public/fileadmin
VOLUME /var/www/html/project/typo3conf
VOLUME /var/www/html/project/typo3temp
VOLUME /var/www/html/project/uploads
VOLUME /var/www/html/project/config
VOLUME /var/www/html/project/var
