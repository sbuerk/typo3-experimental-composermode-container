# Docker image for TYPO3 CMS
# Copyright (C) 2025  Stefan B端rk <stefan@buerk.tech>
#                     and contributors <https://github.com/sbuerk/typo3-experimental-composermode-container/graphs/contributors>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

# NOTE: This file is automatically generated from a template. Please
# do not make any changes to this file directly, and consult the
# CONTRIBUTING document, first.

FROM php:7.4-apache-buster
ARG TARGETPLATFORM
LABEL org.opencontainers.image.authors="Stefan B端rk <stefan@buerk.tech>"
LABEL org.opencontainers.image.source=https://github.org/sbuerk/typo3-experimental-composermode-container/1004
LABEL org.opencontainers.image.url=https://github.org/sbuerk/typo3-experimental-composermode-container/README.md
LABEL org.opencontainers.image.description="sbuerk/typo3-experimental-composermode-container-1004"
LABEL maintainer="Stefan B端rk <stefan@buerk.tech>"

# We use convenient install-php-extensions script to manage additional php extensions
ADD https://github.com/mlocati/docker-php-extension-installer/releases/latest/download/install-php-extensions /usr/local/bin/

ENV APACHE_RUN_SERVERNAME="localhost" \
    APACHE_RUN_DOMAIN="localhost" \
    APACHE_RUN_USER="www-data" \
    APACHE_RUN_GROUP="www-data" \
    APACHE_RUN_DOCROOT="/usr/local/apache2/htdocs" \
    COMPOSER_ALLOW_SUPERUSER=1

# Install TYPO3
RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get install -y --no-install-recommends \
        wget \
# Configure PHP
        libxml2-dev libfreetype6-dev \
        libjpeg62-turbo-dev \
        libmcrypt-dev \
        libpng-dev \
        libpq-dev \
        libzip-dev \
        zlib1g-dev \
# Install required 3rd party tools
        graphicsmagick && \
# Configure extensions
    docker-php-ext-configure gd --with-libdir=/usr/include/ --with-jpeg --with-freetype && \
    docker-php-ext-install -j$(nproc) mysqli soap gd zip opcache intl pgsql pdo_pgsql intl bcmath && \
    echo 'always_populate_raw_post_data = -1\nmax_execution_time = 240\nmax_input_vars = 2500\nupload_max_filesize = 32M\npost_max_size = 32M' > /usr/local/etc/php/conf.d/typo3.ini && \
    chmod +x /usr/local/bin/install-php-extensions && \
    install-php-extensions @composer-2 && \
# Configure Apache as needed
    a2enmod rewrite && \
    sed -i s/'<Directory \/var\/www\/>'/'<Directory  ${APACHE_RUN_DOCROOT}>'/ /etc/apache2/conf-available/docker-php.conf && \
    echo 'DocumentRoot ${APACHE_RUN_DOCROOT}' >> /etc/apache2/conf-available/docker-php.conf && \
    echo 'ServerName ${APACHE_RUN_SERVERNAME}:80' >> /etc/apache2/conf-available/docker-php.conf && \
    sed -i s/'DocumentRoot \/var\/www\/html'/'DocumentRoot ${APACHE_RUN_DOCROOT}'/ /etc/apache2/sites-enabled/000-default.conf && \
    sed -i s/'#ServerName www\.example\.com'/'ServerName ${APACHE_RUN_DOMAIN}'/ /etc/apache2/sites-enabled/000-default.conf && \
    apt-get clean && \
    apt-get -y purge \
        libxml2-dev libfreetype6-dev \
        libjpeg62-turbo-dev \
        libmcrypt-dev \
        libpng-dev \
        libzip-dev \
        zlib1g-dev && \
    rm -rf /var/lib/apt/lists/* /usr/src/*

RUN cd /var/www/html \
    && chown -R ${APACHE_RUN_USER}:${APACHE_RUN_GROUP} . \
    && composer init \
      --name='typo3/demo-instance-104' \
      --author='Stefan B端rk <stefan@buerk.tech>' \
      --type='project' \
      --stability='stable' \
      --license='GPL-2.0-or-later' \
      --no-interaction \
    && composer config "allow-plugins" true \
    && composer require \
        "typo3/cms-about:^10.4" \
        "typo3/cms-adminpanel:^10.4" \
        "typo3/cms-backend:^10.4" \
        "typo3/cms-belog:^10.4" \
        "typo3/cms-beuser:^10.4" \
        "typo3/cms-core:^10.4" \
        "typo3/cms-dashboard:^10.4" \
        "typo3/cms-extbase:^10.4" \
        "typo3/cms-extensionmanager:^10.4" \
        "typo3/cms-filelist:^10.4" \
        "typo3/cms-fluid:^10.4" \
        "typo3/cms-fluid-styled-content:^10.4" \
        "typo3/cms-form:^10.4" \
        "typo3/cms-frontend:^10.4" \
        "typo3/cms-impexp:^10.4" \
        "typo3/cms-info:^10.4" \
        "typo3/cms-install:^10.4" \
        "typo3/cms-lowlevel:^10.4" \
        "typo3/cms-opendocs:^10.4" \
        "typo3/cms-recordlist:^10.4" \
        "typo3/cms-recycler:^10.4" \
        "typo3/cms-redirects:^10.4" \
        "typo3/cms-reports:^10.4" \
        "typo3/cms-rte-ckeditor:^10.4" \
        "typo3/cms-scheduler:^10.4" \
        "typo3/cms-seo:^10.4" \
        "typo3/cms-setup:^10.4" \
        "typo3/cms-tstemplate:^10.4" \
        "typo3/cms-viewpage:^10.4" \
        "helhum/typo3-console":"^6.7.7" \
    && cp public/typo3/sysext/install/Resources/Private/FolderStructureTemplateFiles/root-htaccess public/.htaccess \
    && mkdir -p public/typo3temp \
    && mkdir -p public/typo3conf \
    && mkdir -p public/fileadmin \
    && mkdir -p public/uploads \
    && mkdir -p config \
    && mkdir -p var \
    && chown -R ${APACHE_RUN_USER}:${APACHE_RUN_GROUP} ./

# Configure volumes
VOLUME /var/www/html/public/fileadmin
VOLUME /var/www/html/public/typo3conf
VOLUME /var/www/html/public/typo3temp
VOLUME /var/www/html/public/uploads
VOLUME /var/www/html/config
VOLUME /var/www/html/var
